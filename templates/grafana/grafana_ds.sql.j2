-- {{ ansible_managed }}
-- This script creates the nagflux and elasticsearch datasources into
-- Grafana DB if it doesn't already exists.
-- This is /normally/ automatically applied throught Ansible
-- So you should'd have to manually play it.
--
-- 2019-03-27 - Eric Belhomme <ebelhomme@fr.scc.com>

DROP PROCEDURE IF EXISTS add_grafana_ds;
DELIMITER $
CREATE PROCEDURE add_grafana_ds()
BEGIN
	SET @counter = 0;

	IF NOT EXISTS (SELECT id FROM `data_source` WHERE id=1) THEN
		INSERT INTO `data_source` VALUES (
			1,
			1,
			7,
			'influxdb',
			'nagflux',
			'proxy',
			'http://localhost:8086',
			'{{ mariadb_pwd }}',
			'{{ mariadb_user }}',
			'nagflux',
			0,
			'{{ mariadb_user }}',
			'{{ mariadb_pwd }}',
			1,
			'[]}',
			'2019-04-01 00:00:00',
			'2019-04-01 00:00:00',
			0,
			'{}',
			0
		);
		SET @counter = @counter + 1;
	END IF;

	IF NOT EXISTS (SELECT id FROM `data_source` WHERE id=2) THEN
		INSERT INTO `data_source` VALUES (
			2,
			1,
			4,
			'elasticsearch',
			'Elasticsearch',
			'proxy',
			'http://localhost:9200',
			NULL,
			NULL,
			'metricbeat-*',
			0,
			NULL,
			NULL,
			0,
			'{"esVersion":60,"keepCookies":[],"maxConcurrentShardRequests":256,"timeField":"@timestamp"}',
			'2019-04-01 00:00:00',
			'2019-04-01 00:00:00',
			0,
			'{}',
			0
		);
		SET @counter = @counter + 1;
	END IF;

	IF @counter > 0 THEN
		SELECT 'CHANGED';
	ELSE
		SELECT 'OK';
	END IF;
END $
DELIMITER ;
CALL add_grafana_ds;
